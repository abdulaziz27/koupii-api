name: Deploy Backend (koupii-api)

on:
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts

      - name: Sync source to VPS (exclude server .env and git files)
        run: |
          rsync -az --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.env' \
            --exclude='storage/*' \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ root@${{ secrets.VPS_HOST }}:/srv/apps/koupii-api/current

      - name: Copy Docker files to VPS root app dir
        run: |
          scp -o StrictHostKeyChecking=no Dockerfile.backend root@${{ secrets.VPS_HOST }}:/srv/apps/koupii-api/
          scp -o StrictHostKeyChecking=no docker-compose.yml root@${{ secrets.VPS_HOST }}:/srv/apps/koupii-api/

      - name: Build and restart backend service only (keep MySQL up)
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ secrets.VPS_HOST }} '
            set -e
            cd /srv/apps/koupii-api
            docker compose build backend
            docker compose up -d --no-deps backend
          '

      - name: Run Laravel optimizations and migrations
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ secrets.VPS_HOST }} '
            set -e
            docker exec koupii-backend php artisan config:clear || true
            docker exec koupii-backend php artisan route:clear || true
            docker exec koupii-backend php artisan cache:clear || true
            docker exec koupii-backend php artisan migrate --force
          '

      - name: Health check API
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ secrets.VPS_HOST }} '
            # Check API endpoint with proper JSON header (expect 401 for unauthenticated)
            curl -fsS -H "Accept: application/json" https://api-koupii.magercoding.com/api/profile -w "HTTP_CODE:%{http_code}" | grep -E "(HTTP_CODE:401|HTTP_CODE:200)" || {
              echo "API health check failed"
              exit 1
            }
            echo "API health check passed"
          '

      - name: Print active backend image and env DB
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ secrets.VPS_HOST }} '
            docker ps | grep koupii-backend || true
            docker exec koupii-backend php artisan config:show database.connections.mysql.database
          '

    timeout-minutes: 20
