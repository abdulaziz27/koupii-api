name: Deploy Backend to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.backend
          push: false
          tags: koupii-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "ðŸš€ Deploying Koupii Backend..."

            # Navigate to backend directory
            cd /srv/apps/koupii-api

            # Pull latest code
            git pull origin main

            # Stop existing containers
            docker-compose down

            # Build and start containers
            docker-compose up -d --build

            # Wait for services to be ready
            sleep 10

            # Run Laravel commands
            docker-compose exec -T backend php artisan migrate --force
            docker-compose exec -T backend php artisan config:cache
            docker-compose exec -T backend php artisan route:cache
            docker-compose exec -T backend php artisan view:cache

            # Generate Swagger docs
            docker-compose exec -T backend php artisan l5-swagger:generate

            # Check status
            docker-compose ps

            echo "âœ… Backend deployment completed!"
